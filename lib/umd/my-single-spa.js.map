{"version":3,"file":"my-single-spa.js","sources":["../../src/application/app.helper.js","../../src/start.js","../../src/lifecycles/helper.js","../../src/lifecycles/load.js","../../src/navigations/invoke.js","../../src/application/apps.js"],"sourcesContent":["// 未加载\nexport const NOT_LOADED = \"NOT_LOADED\";\n// 加载时参数校验未通过，或非致命错误\nexport const SKIP_BECAUSE_BROKEN = \"SKIP_BECAUSE_BROKEN\";\n// 加载时遇到致命错误\nexport const LOAD_ERROR = \"LOAD_ERROR\";\n// 加载app代码中\nexport const LOAD_RESOURCE_CODE = \"LOAD_RESOURCE_CODE\"\n\n// 没有加载中断\nexport function notSkipped(app) {\n  return app.status !== SKIP_BECAUSE_BROKEN;\n}\n// 没有加载错误\nexport function withoutLoadError(app) {\n  return app.status !== LOAD_ERROR;\n}\n// 没有被加载过\nexport function isntLoaded(app) {\n  return app.status === NOT_LOADED;\n}\n// 满足app.activityWhen()\nexport function shouldBeActive(app) {\n    console.log(window.location, 'window.location')\n  try {\n    return app.activityWhen(window.location);\n  } catch (e) {\n    app.status = SKIP_BECAUSE_BROKEN;\n  }\n}\n","let started = false;\n\nexport function start() {}\n\n// 判断系统是否已启动\nexport function isStarted() {\n    return started\n}\n","// 判断是否是一个Promise\nexport function smellLikeAPromise(promise) {\n  if (promise instanceof Promise) {\n    return true;\n  }\n  //   自己构造的\n  return typeof promise === \"object\" && typeof promise.then === \"function\" && typeof promise.catch === \"function\";\n}\n\n// 判断生命周期是否合法\nexport function validateLifeCyclesFn() {\n  if (typeof fn === \"function\") {\n    return true;\n  }\n  if (Array.isArray(fn)) {\n    return fn.filter((item) => typeof item !== \"function\").length === 0;\n  }\n  return false;\n}\n\nexport function flattenLifecycleArray(fns, description) {\n  if (!Array.isArray(fns)) {\n    fns = [fns];\n  }\n\n  if (fns.length === 0) {\n    fns = [() => Promise.resolve()];\n  }\n\n  return function (props) {\n    return new Promise((resolve, reject) => {\n      waitForPromises(0);\n\n      function waitForPromises(index) {\n        let fn = fns[index](props);\n        if (!smellLikeAPromise(fn)) {\n          reject(`${description} at index ${index} did not return a promise`);\n          return;\n        }\n        fn.then(() => {\n          if (index === fns.length - 1) {\n            resolve();\n          } else {\n            waitForPromises(++index);\n          }\n        }).catch((e) => {\n          reject(e);\n        });\n      }\n    });\n  };\n}\n","import { NOT_LOADED, LOAD_RESOURCE_CODE, SKIP_BECAUSE_BROKEN } from \"../application/app.helper\";\nimport { smellLikeAPromise, validateLifeCyclesFn, flattenLifecycleArray } from \"./helper\";\n\nexport function toLoadPromise(app) {\n  // 状态不满足需要被load\n  if (app.status !== NOT_LOADED) {\n    return Promise.resolve(app);\n  }\n\n  app.status = LOAD_RESOURCE_CODE;\n  let loadPromise = app.loadFunction();\n\n  //   不是Promise 返回错误\n  if (!smellLikeAPromise(loadPromise)) {\n    return Promise.reject(new Error(\"\"));\n  }\n\n  loadPromise.then((appConfig) => {\n    if (typeof appConfig !== \"object\") {\n      throw new Error(\"\");\n    }\n\n    //   生命周期 bootstrap mount unmount\n    // 判断生命周期是否存在并且合法\n    let errorMsg = [][(\"bootstrap\", \"mount\", \"unmount\")].forEach((lifecycle) => {\n      if (!validateLifeCyclesFn(appConfig[lifecycle])) {\n        errorMsg.push(`app:${app.name} dost not export ${lifecycle} as a function or function array`);\n      }\n    });\n    if (errorMsg.length) {\n      app.status = SKIP_BECAUSE_BROKEN;\n      return;\n    }\n\n    app.bootstrap = flattenLifecycleArray(appConfig.bootstrap);\n    app.mount = flattenLifecycleArray(appConfig.mount);\n    app.unmount = flattenLifecycleArray(appConfig.unmount);\n  });\n}\n","import { isStarted } from \"../start\";\nimport { getAppsToLoad } from \"../application/apps\";\nimport { toLoadPromise } from \"../lifecycles/load\";\n\nlet loadAppsUnderway = false; // 标记循环的状态\nlet changesQueue = [];\n\n/**\n * 核心功能\n */\nexport function invoke() {\n  if (loadAppsUnderway) {\n    return new Promise((resolve, reject) => {\n      changesQueue.push({\n        success: resolve,\n        failure: reject,\n      });\n    });\n  }\n  loadAppsUnderway = true;\n\n  // 判断系统是否启动\n  if (isStarted()) {\n    // 系统已经启动 > 启动APPS\n  } else {\n    // 系统未启动 > 加载APPS\n    loadApps();\n  }\n\n  // 加载APPS\n  function loadApps() {\n    // 获取需要被load的APP\n    getAppsToLoad().map(toLoadPromise);\n  }\n}\n","import { NOT_LOADED, notSkipped, withoutLoadError, isntLoaded, shouldBeActive } from \"./app.helper\";\nimport { invoke } from \"../navigations/invoke\";\n\nconst APPS = [];\n/**\n * 注册app\n * @param {string} appName 要注册的app名称\n * @param {Function<Promise> | Object} applicationOrLoadFunction app异步加载函数或者app内容\n * @param {Function<boolean>} activityWhen 判断app应该在何时被启动\n * @param {Object} customProps 自定义配置\n */\nexport function registerApplication(appName, applicationOrLoadFunction, activityWhen, customProps = {}) {\n  // 参数判断\n  if (!appName || typeof appName !== \"string\") {\n    throw new Error(\"the app name must be a non-empty string\");\n  }\n  // if (applicationOrLoadFunction().indexOf(appName) !== -1) {\n  //   throw new Error(\"There is already an app declared with name \" + appName);\n  // }\n  if (typeof customProps !== \"object\" || Array.isArray(customProps)) {\n    throw new Error(\"the customProps must be a pure object\");\n  }\n\n  if (!applicationOrLoadFunction) {\n    throw new Error(\"the application or load function is required\");\n  }\n\n  if (typeof activityWhen !== \"function\") {\n    throw new Error(\"the activityWhen must be a function\");\n  }\n\n  // 如果 applicationOrLoadFunction 不是函数（即对象），转成函数\n  if (typeof applicationOrLoadFunction !== \"function\") {\n    applicationOrLoadFunction = () => Promise.resolve(applicationOrLoadFunction);\n  }\n\n  APPS.push({\n    name: appName,\n    loadApp: applicationOrLoadFunction,\n    activityWhen,\n    customProps,\n    status: NOT_LOADED,\n    services: {},\n  });\n  invoke();\n}\n\n/**\n * 获取满足加载条件的app\n * 1、没有加载中断\n * 2、没有加载错误\n * 3、没有被加载过\n * 4、满足app.activityWhen()\n * @return {*[]}\n */\nexport function getAppsToLoad() {\n  return APPS.filter(notSkipped).filter(withoutLoadError).filter(isntLoaded).filter(shouldBeActive);\n}\n"],"names":["NOT_LOADED","SKIP_BECAUSE_BROKEN","LOAD_ERROR","LOAD_RESOURCE_CODE","notSkipped","app","status","withoutLoadError","isntLoaded","shouldBeActive","console","log","window","location","activityWhen","e","start","smellLikeAPromise","promise","Promise","then","catch","validateLifeCyclesFn","fn","Array","isArray","filter","item","length","flattenLifecycleArray","fns","description","resolve","props","reject","waitForPromises","index","toLoadPromise","loadPromise","loadFunction","Error","appConfig","errorMsg","forEach","lifecycle","push","name","bootstrap","mount","unmount","loadAppsUnderway","invoke","loadApps","getAppsToLoad","map","APPS","registerApplication","appName","applicationOrLoadFunction","customProps","loadApp","services"],"mappings":"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"}